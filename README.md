# Exploitation


الإستغلال هو نوع من البرامج تم إنشاؤها لإستهداف نقطة ضعف معينة يتضمن تعريف الإستغلال أي شيء من تطبيقات البرامج الكاملة إلى سلاسل التعليمات البرمجية، وصولاً إلى تسلسلات الأوامر البسيطة.

بمعنى آخر ، الإستغلال هي أداة تسمح للمهاجم بالاستفادة من ثغرة أمنية لتحقيق الغرض الذي يريده





## Types of exploitations


فيه 3 أنواع من الإستغلال :

1: Client-side exploitation :

 فكرة هذا الإستغلال تتطلب عادةً تفاعل المستخدم من أجل التشغيل (مثلاً يفتح المستخدم رابط معين).

2 : Remote exploits :

 لاتتطلب تفاعل المستخدم وهذا يعني انه يستطيع المهاجم التحكم عن بعد. وعادةً تؤثر على الخدمات.

3 : Local Privilege escalation :

 .يستطيع المهاجم أن يصل للجهاز لكن لا تُشكّل خطراً حقيقياً إلا إذا كان هناك إحتكاك مباشر مع الهدف((Target) معين  ، اي ان المهاجم داخل الشبكة






## Windows Authentication Weaknesses 


NTLM ( New Technology LAN Manager ) : 

يتعين علينا أولاً فهم كيفية عمل NTLM.

فيه ثلاث أنواع من الرسائل :

النوع الأول : التفاوض (Negotiation)


النوع الثاني : التحدي (Challenge)

النوع الثالث : المصادقة (Authentication)



## Windows Authentication Weaknesses 

طريقة عمل ال Challenge/Response كالتالي:

1- في هذه العملية ، يرسل العميل رسالة من النوع 1 التفاوض (Negotiation) إلى الخادم ، والتي تحتوي بشكل أساسي على قائمة الوظائف التي يدعمها العميل ويطلبها الخادم ويحتوي أيضاُ على اسم المستخدم في ال Plain text .

2- في هذه العملية ، يستجيب الخادم برسالة من النوع 2 التحدي (Challenge) ، والتي تحتوي على قائمة بالوظائف التي يدعمها ويوافق عليها الخادم. ولكن الأهم من ذلك ، أنه يحتوي على التحدي الذي تم إنشاؤه بواسطة الخادم.

3- نوع المصادقة 3

في هذه العملية ، بعد أن يتلقى العميل التحدي ، يستخدم تجزئة وتحدي المستخدم لإجراء عملية تشفير للحصول على الاستجابة ، ثم يرسل الاستجابة واسم المستخدم والتحدي إلى الخادم. الاستجابة في الرسالة هي الجزء الأكثر أهمية ، لأنها تثبت للخادم أن مستخدم العميل يعرف بالفعل كلمة مرور الحساب.


## How the responses (Type 3 = Authentication) are generated and why are they so weak.



## LM/NTLMv1 (LM Hash)

أولاً الخوارزمية المستخدمة لحساب الLM Hash هي الDES 

( الDES ببساطة هي ال Data Encryption Standard )

[DES](https://www.geeksforgeeks.org/data-encryption-standard-des-set-1/)


الأن هذه الخطوات التي يقوم بها الWindows :

1-يتم تحويل كلمة مرور المستخدم إلى أحرف كبيرة ، ويتم تحويل كلمة المرور إلى سلسلة سداسية عشرية. إذا كانت أقل من 14 بايت ، فسيتم استخدام 0 لإكمالها.

2- يتم تقسيم السلسلة السداسية العشرية لكلمة المرور إلى جزأين 7 بايت. يتم تحويل كل جزء إلى تيار بت ، والطول 56 بت ، والطول غير كافٍ ، استخدم 0 لملء الطول على اليسار

3- قسّم 7 بتات إلى مجموعة ، وأضف 0 إلى نهاية كل مجموعة ، ثم شكل مجموعة

4- يتم استخدام المجموعتين اللتين تم الحصول عليهما في الخطوة السابقة كمفتاح "KGS! @ # $٪" لتشفير DES.

5- قم بربط المجموعتين المشفرتين معًا للحصول على قيمة LM HASH النهائية.

![LM-Hash](https://github.com/MariamAlrashidi/Exploitation-/blob/main/LM-Hash.jpg)



## LM/NTLMv1 (NTLM Hash)

1- نقوم أولاً بتحويل كلمة مرور المستخدم إلى تنسيق سداسي عشري. Hexadecimal 

2. نقوم بتشفير كلمة المرور بتنسيق سداسي عشري باستخدام Unicode.

3. استخدم خوارزمية MD4 لحساب تجزئة البيانات المشفرة بنظام Unicode


الآن بعد أن عرفنا كيف يحسب Windows  LMhash و NThash ، دعنا نلخص كيفية عمل بروتوكولات المصادقة LM و NTLM من أجل فهم كيفية مهاجمتها تمامًا.  كما تعلم بالفعل ، يتم استخدام هذه البروتوكولات لمصادقة العميل على الخادم ، حيث يكون للخادم طريقة ما للتحقق من بيانات الاعتماد المرسلة من قبل العميل.  لاحظ أن كلا البروتوكولين متطابقان ، باستثناء ال Hash التي يستخدمونها في رسالتهم في الخطوة 3 (Authentication).


 
## فكرة عمل البرتوكولاين هي كالتالي:
![Tow protocols](https://github.com/MariamAlrashidi/Exploitation-/blob/main/two-protocols.jpg)

1- المستخدم يرسل رسالة يتفاوض بها مع الخادم واللي تحتوي على إسم المستخدم كنص عادي أو مايسمى بالPlaintex , التفاوض هذا يسمى بال(Negotiation)

2- الخادم أو السيرفر راح يرد بكلمة عشوائية تسمى بال "Nonce" أو ال"challenge" للحصول على الshare secrets 

3- المستخدم راح يقوم بالعملية الحسابية الخاصة بال share secrets المرسل من المستخدم إلى الخادم , تسمى هذه العملية بالمصادقة أو الAuthentication

بمعنى تفصيلي :


 فكرة هذه البروتوكولين  يقومان على الshare secrets .. مبدأ الshare secrets لنفترض أن عندنا شخصين عارفين سر معين ويحتاجون يتأكدون إن فعلًا عارفين السر هذا
من غيركل الأشخاص اللي حولهم تعرف هذا السر , ببساطة ممكن الشخص الأول يرسل للشخص الثاني يطلب منه أي كلمة عشوائية (Negotiation) , فبالتالي يرد بشكل عشوائي بأي كلمة منه , فالشخص الأول يسوي تشفير للكلمة هذي بالإضافة إلى السر اللي 
بينهم ويرسلها للشخص الثاني, الشخص الثاني يقوم بنفس العملية عشان يحصل على النتائج وهي هذه العملية :

معادلة الshare secrets تكون كالتالي :


share secrets = MD5(Value+Password) 


في حالة أن ناتج العمليتين ال (Values) متطابقين فالبتالي السر اللي بينهم متطابق.. في  هالحالة كل الناس اللي تسمعهم ماراح تعرف السر اللي بينهم.



الأن بعد مافهمنا كيفية عمل البرتوكلين .. نجي لفكرة كيف ال attacker يحصلون على ال password hash من خلال إنتحالهم لشخصية الخادم أو السيرفر .. أهم خطوة في طريفة عمل البروتوكلين السابقة هي خطوة رقم ثلاث .. ليه؟ 
لأن بعد تلقي رسالة Type3 ، سيخضع الخادم لنفس العملية الحسابية تقريبًا ويقارن ما إذا كانت رسالة المصادقة المحسوبة بنفسها تتطابق مع رسالة
المصادقة المرسلة من قبل الخادم. إذا تطابقت ، فهذا يثبت أن العميل لديه كلمة المرور الصحيحة وأن المصادقة ناجحة. اسمح للعميل باستخدام الخدمات اللاحقة. إذا لم تتطابق ، تفشل المصادقة.


قبل الدخول في التفاصيل .. يوجد إصدارين ل(LM/NTLMv1) , (LM/NTMMv2)


## هيكل رسالة المصادقة في LM/NTLMv1 :

 1-  يرسل المستخدم ال user name  لخادم ك plaintext
2-    يقوم السيرفر بإنشاء رقم عشوائي 16 بايت يسمى بال(Challgenge) اللي راح يتم إرساله إلى المستخدم
   هو ملء مساحة تجزئة NTLM ذات 16 بايت إلى 21 بايت ، ثم تقسيمها إلى ثلاث مجموعات ،كل مجموعة مكونة من 7 بتات ، كمجموعات مفاتيح 
ثلاثية لخوارزمية تشفير 3DES ، وتشفير التحدي الذي أرسله الخادم. قم بتوصيل هذه القيم الثلاث للنص المشفر للحصول على الاستجابة.
    بعد استلام ال (Challgenge) ، يقوم المستخدم بعمل encrypt  لهذا الChallgenge،  باستخدام password hash. وهذا ما يسمى بالاستجابة أو ال response 
، ثم ينقل التحدي والاستجابة واسم المستخدم إلى الخادم.

  بعد أن يتلقى الخادم النسخ الثلاث من المحتوى الذي يرسله العميل ، يقوم بإعادة توجيهه إلى domain controller
  بعد تلقي اسم المستخدم والاستجابة والتحدي ، يجد DC تجزئة كلمة المرور المطابقة في قاعدة بيانات الحساب وفقًا لاسم المستخدم ، ثم يستخدم تجزئة كلمة المرور هذه لتشفير التحدي
    الخطوة الأخيرة هي أن العميل يقارن اللChallgenge response المشفر. إذا كانا متطابقين ، يكون التحقق من NTLM ناجحًا. 


فكر عمل ال Domain Controller كالتالي :

عبارة عن مجموعة من اجهزة الكمبيوتر ومن المستخدمين، وايضا مجموعات المستخدمين وربطها بالـ Domain للتحكم بها وإعطاء الصلاحيات اللازمة لكل مستخدم




## في حالة أن ال attacker إستغلها بحيث يحصل على ال client response في النوع الثالث وهو ال authentication فراح يكون لل attacker طريقتان :

الطريقة الأولى : إجبار المستخدم  واللي راح يكون هو الtaget المطلوب يإنه يبدأ بالإتصال بالخادم المزيّف 
الطريقة الثانية :  يكون (Man-in-the-Middle techniques) من أجل عمل sniff لclinet response


## الأن راح نركز على أول طريقة :

عشان نجبر المستخدم فإنه يتصل بالخادم المزيّف راح نسوي إنشاء لما يُسمى بال"SMB Listening" بحيث تقبل ال connection وترسل مايُسمى بالfixed challenge ليه ؟ عشان
تساعدنا في مسألة فك التشفير الخاص بال response .. وعشان نسويها راح نستخدم ال Metasploit Module التالي :

https://web.archive.org/web/20140819013932/http:/www.rapid7.com/db/modules/auxiliary/server/capture/smb
 

## واحدة من أسهل الطرق هي فرض برتوكول NTLM هي من خلال ال SMB authentcation 


## الLMHASH والNTHASH  تتمثل في إستجابة المستخدم أثناء برتوكول NTLM 

(هل يوجد فرق مابين الLMHASH وال NTHASH؟ نعم , بالبداية لازم نعرف أن الويندوز يُخرن كلمات المرور في ملف يُسمى بالSAM  
وهي اختصار ل Security Accounts Manager Database . تستخدم من قبل ويندوز لإدارة حسابات المستخدمين وكلمات المرور في شكل الهاش hashed format حيث لا يتم تخزين كلمة السر ابدا في شكلها العادي
. لكن يتم تخزينها في شكل الهاش ليتم حمايتها من الهجمات. قاعدة بيانات SAM يتم تنفيذها كملف رجيستري registry file.
يتم وضع ملف SAM في المسار(C:\Windows\System32\config)


 ## NTLMv2
 
 
مبدئياً هي عبارة عن إصدار جديد لNTLMv1
ايش تفرق عن الإصدار القديم؟ تختلف عنها بالخطوة الثالثة أو بالنوع الثالث وهي ال authentication بحيث تم إنشاؤها بطريقة مختلفة.


## طريقة عمل ال NTLMv2:

استخدم NTLMv2 hash المكونة من 16 بايت كمفتاح لتشفير قيمة باستخدام خوارزمية رمز مصادقة رسالة HMAC-MD5 (يتم تقسيم التحدي و Blob من النوع 2 معًا). احصل على جهاز NTProofStr سعة 16 بايت.

(4). اجمع بين NTProofStr و Blob لتكوين الresponse.

 يتم تحديد الresponse الإصدار المحدد بواسطة LmCompatibilityLevel.
 
 
  ليش يتم تحديد ال LmCompatibilityLevel؟
  
  
  فكرة الLmCompatibilityLevel بشكل مبسط هي تكون كالتالي :
  تُطّبق في إعدادت ال domain controller وخوادم المستخدمين عشان يتجنب أي مشكلة تحدث وأي configuration خاطئ يقوم بتجنبه
  
  
  
تحتوي استجابة النوع 3 في آلية التحقق من ال challegnge / response على Net-ntlm hash تتوافق NTLM v1 response و NTLMv2 response مع Net-ntlm hashالمقسمة إلى Net-ntlm v1 hash و Net-ntlm v2 hash.


تنسيق Net-ntlm hash v1 هو:

username::hostname:LM response:NTLM response:challenge


تنسيق Net-ntlm hash v2 هو:

username::domain:challenge:HMAC-MD5:blob


من الصعب إن ال attacker يقدر ينشئ rinbow table او Dictionary attack من أجل أن يجمعون ال NTHash لكن في الحالة الممكنة أن الattacker هي الbrute-forcing


يوجد نوع آخر تسمح للمهاجم بإعادة استخدام محاولات ال Authentication من أجل الوصول إلى نظام ما في الشبكة , هذا النوع يُسمى بال "SMB Relay attacks on NTLMv1"


## طريقة عمل NTLM challenge/response protocols :


1- يرسل المستخدم طلب لل authentication
2- الخادم يرسل قيمة عشوائية تُسمى بالchallenge
3- المستخدم يقوم بتشفير الchallenge بإستخدام ال password hash ثم يرسلها مرة أخرى
4- الخادم يحاول فك التشفير هذا الchallenge/response


## المهاجم في هذه الحالة يتصرف كMan in Middel :

1- يحدد المهاجم الهدف وينتظر حتى يحاول شخص في الشبكة المصادقة على جهازه , عندما يحاول الجهاز المصادقة على هذا المهاجم, راح يرسل محاولة المصادقة للهدف المحدد , ينشئ الهدف 
الchallenge ويرسله مرة ثانية للمهاجم هذا الchallenge إلى الماشين اللي بدأ الإتصال به أولًا .. ثم يقوم هذا الماشين بتشفير الchallenge بإستخدام الpassword hash 
ويرسله مرة أخرى للمهاجم. المهاجم يرسل هذا الchallenge المشفر إلى الهدف ويصادق على نفسه 

![diagram-attack](https://github.com/MariamAlrashidi/Exploitation-/blob/main/diagram-attack.jpg)


## في ال Metasploit راح يتم إستخدام ال smb relay module :

https://pentestlab.blog/tag/smb-relay/


## Clinet-Side Exploitation :

 هي عبارة عن هجمات التي تتعلق بالـApplication  التي تتعامل معها يوميا مثل المتصفحات أو برامج قراءة النصوص PDF وهكذا .. كيف تتم هذه الهجمات ؟ هذه الهجمات تتم مثلا 
من خلال أن يرسل المهاجم لك إميل به PDF  وهذا الملف به الصور مثلا بالإضافة إلى Malicious Data  مختفية .. في هذه الحالة عندما تقوم بتحميل هذا الملف وتشغيله مثلا من خلال Acrobat Reader
   ولكنك تستخدم إصدار به بعض العيوب التي من الممكن استغلالها من خلال الـ Malicious Data  في هذه الحالة ستتم عملية الاستغلال 



في الMetasploit module اللي راح نستخدمها :

https://www.zerodayinitiative.com/advisories/ZDI-15-110/

https://web.archive.org/web/20171202110853/https:/www.rapid7.com/db/modules/exploit/multi/browser/adobe_flash_hacking_team_uaf



## Remote-Side Exploitation :

هي عبارة عن إستغلال يتم عن بُعد بحيث لايتطلب هذا الإستغلال التفاعل مما يجعله أكثر خطورة , تستهدف هذه الهجمات كلاً من التطبيقات والبرامج اللي تعرض الخدمات 
ولأن الـServer تقوم باستضافة خدمات فهي تكون هدف للمخترق الذي يحاول استغلال هذه الخدمات للسيطرة على الـServer . 







