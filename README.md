# Exploitation


الإستغلال هو نوع من البرامج تم إنشاؤها لإستهداف نقطة ضعف معينة يتضمن تعريف الإستغلال أي شيء من تطبيقات البرامج الكاملة إلى سلاسل التعليمات البرمجية، وصولاً إلى تسلسلات الأوامر البسيطة.

بمعنى آخر ، الإستغلال هي أداة تسمح للمهاجم بالاستفادة من ثغرة أمنية لتحقيق الغرض الذي يريده

## Types of exploitations


فيه 3 أنواع من الإستغلال :

1: Client-side exploitation :

 فكرة هذا الإستغلال تتطلب عادةً تفاعل المستخدم من أجل التشغيل (مثلاً يفتح المستخدم رابط معين).

2 : Remote exploits :

 لاتتطلب تفاعل المستخدم وهذا يعني انه يستطيع المهاجم التحكم عن بعد. وعادةً تؤثر على الخدمات.

3 : Local Privilege escalation :

 .يستطيع المهاجم أن يصل للجهاز لكن لا تُشكّل خطراً حقيقياً إلا إذا كان هناك إحتكاك مباشر مع الهدف((Target) معين  ، اي ان المهاجم داخل الشبكة



## تحتوي خوارزمية تشفير LM على بعض نقاط الضعف الكامنة

    أولاً ، يمكن أن يكون الحد الأقصى لطول كلمة المرور 14 حرفًا فقط
    كلمة المرور ليست حساسة لحالة الأحرف. قبل إنشاء قيمة التجزئة ، سيتم تحويل جميع كلمات المرور إلى أحرف كبيرة
    بالنظر إلى عملية التشفير لدينا ، يمكننا أن نرى أننا نستخدم DES المجمعة. إذا كانت قوة كلمة المرور أقل من 7 بتات ، فيجب أن تكون نتيجة تشفير المجموعة الثانية aad3b435b51404ee. إذا رأينا أن نهاية تجزئة lm هي aad3b435b51404ee ، من السهل أن تجد أن قوة كلمة المرور أقل من 7 أرقام
    يتم تقسيم كلمة المرور المكونة من 14 حرفًا إلى 7 + 7 أحرف ، ويتم حساب قيمة التجزئة للنصفين. هذه الطريقة في حساب قيمة التجزئة تضاعف من صعوبة التكسير ، لأن المهاجم يحتاج إلى إجبار قوة تكسير 7 أحرف بدلاً من 14 حرفًا. هذا يجعل القوة الفعالة لكلمة المرور المكونة من 14 حرفًا تساوي أو ضعف قوة كلمة المرور المكونة من 7 أحرف ، وهي أقل تعقيدًا منالقوة النظرية لكلمة مرور مكونة من 14 حرفًا.
    كلمة مرور Des ليست قوية




## حساب LM Hash (LAN Manager Hash) :
********* رسمة سلايد 16 **********************

    يتم تحويل كلمة مرور المستخدم إلى أحرف كبيرة ، ويتم تحويل كلمة المرور إلى سلسلة سداسية عشرية. إذا كانت أقل من 14 بايت ، فسيتم استخدام 0 لإكمالها.
    يتم تقسيم السلسلة السداسية العشرية لكلمة المرور إلى جزأين 7 بايت. يتم تحويل كل جزء إلى تيار بت ، والطول 56 بت ، والطول غير كافٍ ، استخدم 0 لملء الطول على اليسار
    قسّم 7 بتات إلى مجموعة ، وأضف 0 إلى نهاية كل مجموعة ، ثم شكل مجموعة
    يتم استخدام المجموعتين اللتين تم الحصول عليهما في الخطوة السابقة كمفتاح "KGS! @ # $٪" لتشفير DES.
    قم بربط المجموعتين المشفرتين معًا للحصول على قيمة LM HASH النهائية.
 

## الDES ببساطة هي الData Encryption Standard مرجع عنها للقراءة : https://www.geeksforgeeks.org/data-encryption-standard-des-set-1/



الأن بعد ماعرفنا كيف يحسب الويندوز هاش lm و ntml ... حنشرح كيفية عمل برتوكولات المصادقة أو Authentcation protolcols 
تعتبر هذه البرتوكولات لمصادقة المستخدم علة الخادم . بحيث يكون للخادم طريقة ما للتحقق من البيانات اللي يرسلها المستخدم 



************* رسمة سلايد 20 ***********************

## فكرة عمل البرتوكولاين هي كالتالي:

******************الرسمة **********************************
1- المستخدم يرسل رسالة يتفاوض بها مع الخادم واللي تحتوي على إسم المستخدم كنص عادي أو مايسمى بالPlaintex , التفاوض هذا يسمى بال(Negotiation)
2- الخادم أو السيرفر راح يرد بكلمة عشوائية تسمى بال "Nonce" أو ال"challenge" للحصول على الshare secrets 
3- المستخدم راح يقوم بالعملية الحسابية الخاصة بالsharev secrets المرسلى من المستخدم إلى الخادم , تسمى هذه العملية بالمصادقة أو الAuthentication


الأن بعد مافهمنا كيفية عمل االبرتوكلين .. نجي لفكرة كيف الattacker يحصلون على الpassword hash من خلال إنتحالهم لشخصية الخادم أو السيرفر .. أهم خطوة في طريفة عمل البروتوكلين السابقة هي خطوة رقم ثلاث .. ليه؟ 
لأن بعد تلقي رسالة Type3 ، سيخخضع الخادم لنفس العملية الحسابية تقريبًا ويقارن ما إذا كانت رسالة المصادقة المحسوبة بنفسها تتطابق مع رسالة
المصادقة المرسلة من قبل الخادم. إذا تطابقت ، فهذا يثبت أن العميل لديه كلمة المرور الصحيحة وأن المصادقة ناجحة. اسمح للعميل باستخدام الخدمات اللاحقة. إذا لم تتطابق ، تفشل المصادقة.


قبل الدخول في التفاصيل .. يوجد إصدارين ل(LM/NTLMv1) , (LM/NTMMv2)


## هيكل رسالى المصادة في LM/NTLMv1 :

    يرسل المستخدم الuser name  لخادم ك plaintext
    يقوم السيرفر بإنشاء رقم عشوائي 16 بايت يسمى بال(Challgenge) اللي راح يتم إرساله إلى المستخدم
   هو ملء مساحة تجزئة NTLM ذات 16 بايت إلى 21 بايت ، ثم تقسيمها إلى ثلاث مجموعات ،كل مجموعة مكونة من 7 بتات ، كمجموعات مفاتيح 
ثلاثية لخوارزمية تشفير 3DES ، وتشفير التحدي الذي أرسله الخادم. قم بتوصيل هذه القيم الثلاث للنص المشفر للحصول على الاستجابة.
    بعد استلام ال(Challgenge) ، يقوم المستخدم بعمل encrypt  لهذا الChallgenge،  باستخدام password hash. وهذا ما يسمى بالاستجابة أو الresponse 
، ثم ينقل التحدي والاستجابة واسم المستخدم إلى الخادم.

    بعد أن يتلقى الخادم النسخ الثلاث من المحتوى الذي يرسله العميل ، يقوم بإعادة توجيهه إلى domain controller
    بعد تلقي اسم المستخدم والاستجابة والتحدي ، يجد DC تجزئة كلمة المرور المطابقة في قاعدة بيانات الحساب وفقًا لاسم المستخدم ، ثم يستخدم تجزئة كلمة المرور هذه لتشفير التحدي
    الخطوة الأخيرة هي أن العميل يقارن اللChallgenge response المشفر. إذا كانا متطابقين ، يكون التحقق من NTLM ناجحًا. 


## في حالة أن الattacker إستغلها بحيث يحصل على الclient response في النوع الثالث وهو الauthentication فراح يكون للattacker طريقتان :

الطريقة الأولى : إجبار المستخدم  واللي حيكون هو الtaget المطلوب يإنه يبدأ بالإتصال بالخادم المزيّف 
الطريقة الثانية :  يكون (Man-in-the-Middle techniques) من أجل عمل sniff لclinet response 


## الأن راح نركز على أول طريقة :

عشان نجبر المستخدم فإنه يتصل بالحادم المزيّف حنسوي إنشاء لما يُسمى بال"SMB Listening" بحيث تقبل الconnection وترسل مايُسمى بالfixed challenge ليه ؟ عشان
تساعدنا في مسألة فك التشفير الخاص بالresponse .. وعشان نسويها راح نستخدم الMetasploit Module التالي :

https://web.archive.org/web/20140819013932/http:/www.rapid7.com/db/modules/auxiliary/server/capture/smb

سلايد 32 

## واحدة من أسهل الطرق هي فرض برتوكول NTLM هي من خلال الSMB authentcation 


## الLMHASH والNTHASH  تتمثل في إستجابة المستخدم أثناء برتوكول NTLM 

(هل يوجد فرق مابين الLMHASH والNTHASH؟ نعم , بالبداية لازم نعرف أن الويندوز يُخرن كلمات المرور في ملف يُسمى بالSAM  
وهي اختصار ل Security Accounts Manager Database . تستخدم من قبل ويندوز لإدارة حسابات المستخدمين وكلمات المرور في شكل الهاش hashed format حيث لا يتم تخزين كلمة السر ابدا في شكلها العادي
. لكن يتم تخزينها في شكل الهاش ليتم حمايتها من الهجمات. قاعدة بيانات SAM يتم تنفيذها كملف رجيستري registry file.
يتم وضع ملف SAM في المسار(C:\Windows\System32\config)



....................................................................................................\




 ## NTLMv2

مبدئياً هي عبدارة عن إصدار جديد لNTLMv1

ايش تفرق عن الإصدار القديم؟ تختلف عنها بالخطوة الثالثة أو بالنوع الثالث وهي الauthentication بحيث تم إنشاؤها بطريقة مختلفة.

## طريقة عمل الNTLMv2:

استخدم NTLMv2 hash المكونة من 16 بايت كمفتاح لتشفير قيمة باستخدام خوارزمية رمز مصادقة رسالة HMAC-MD5 (يتم تقسيم التحدي و Blob من النوع 2 معًا). احصل على جهاز NTProofStr سعة 16 بايت.

(4). اجمع بين NTProofStr و Blob لتكوين الresponse.

    يتم تحديد الresponse الإصدار المحدد بواسطة LmCompatibilityLevel.

تحتوي استجابة النوع 3 في آلية التحقق من الchallegnge / response على Net-ntlm hash تتوافق NTLM v1 response و NTLMv2 response مع Net-ntlm hashالمقسمة إلى Net-ntlm v1 hashوتجزئة Net-ntlm v2.

تنسيق Net-ntlm hash v1 هو:

username::hostname:LM response:NTLM response:challenge

تنسيق Net-ntlm hash v2 هو:

username::domain:challenge:HMAC-MD5:blob



من الصعب إن الattacker يقدر ينشئ rinbow table او Dictionary attack من أجل أن يجمعون الNTHash لكن في الحالة الممكنة أن الattacker هي الbrute-forcing



يوجد نوع آخر تسمح للمهاجم بإعادة استخدام محاولات المصادقة من أجل الوصول إلى نظام ما في الشبكة , هذا النوع يُسمى بال "SMB Relay attacks on NTLMv1"


## طريقة عمل NTLM challenge/response protocols :

1- يرسل المستخدم طلب للauthentication
2- الخادم يرسل قيمة عشوائية تُسمى بالchallenge
3- المستخدم يقوم بتشفير الchallenge بإستخدام الpassword hash ثم يرسلها مرة أخرى
4- الخادم يحاول فك التشفير هذا الchallenge/response


## المهاجم في هذه الحالة يتصرف كman in middel :
1- يحدد المهاجم الهدف وينتظر حتى يحاول شخص في الشبكة المصادقة على جهازه , عندما يحاول الجهاز المصادقة على هذا المهاجم, راح يرسل محاولة المصادقة للهدف المحدد , ينشئ الهدف 
الchallenge ويرسله مرة ثانية للمهاجم هذا الchallenge إلى الماشين اللي بدأ الإتصال به أولًا .. ثم يقوم هذا الماشين بتشفير الchallenge بإستخدام الpassword hash 
ويرسله مرة أخرى للمهاجم. المهاجم يرسل هذا الchallenge المشفر إلى الهدف ويصادق على نفسه 

سلايد 71 رسمة **************************


## في الMetasploit راح يتم إستخدام الsmb relay module :


رابط *******************************************



مجموعة روابط قبل سلايد 94 















,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,

 ## Clinet-Side Exploitation :

 هي عبارة عن هجمات التي تتعلق بالـApplication  التي تتعامل معها يوميا مثل المتصفحات أو برامج قراءة النصوص PDF وهكذا .. كيف تتم هذه الهجمات ؟ هذه الهجمات تتم مثلا 
من خلال أن يرسل المهاجم لك إميل به PDF  وهذا الملف به الصور مثلا بالإضافة إلى Malicious Data  مختفية .. في هذه الحالة عندما تقوم بتحميل هذا الملف وتشغيله مثلا من خلال Acrobat Reader
   ولكنك تستخدم إصدار به بعض العيوب التي من الممكن استغلالها من خلال الـMalicious Data  في هذه الحالة ستتم عملية الاستغلال 

في الMetasploit module اللي راح نستخدمها :
https://www.zerodayinitiative.com/advisories/ZDI-15-110/

https://web.archive.org/web/20171202110853/https:/www.rapid7.com/db/modules/exploit/multi/browser/adobe_flash_hacking_team_uaf


## Remote-Side Exploitation :

هي عبارة عن إستغلال يتم عن بُعد بحيث لايتطلب هذا الإستغلال التفاعل مما يجعله أكثر خطورة , تستهدف هذه الهجمات كلاً من التطبيقات والبرامج اللي تعرض الخدمات 
ولأن الـServer تقوم باستضافة خدمات فهي تكون هدف للمخترق الذي يحاول استغلال هذه الخدمات للسيطرة على الـServer . 





